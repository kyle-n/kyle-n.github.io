import{s as Xt,n as Ke}from"./scheduler.63274e7e.js";import{S as el,i as tl,g as s,s as a,H as Dt,h as n,x as r,c as o,j as Bt,A as Yt,f as l,k as Qt,a as i}from"./index.9f372ec1.js";function ll(Zt){let c,Xe='At ServiceCore, we’re thrilled to ship <a href="https://support.servicecore.com/hc/en-us/articles/360041523411-Add-Rental-Rates" rel="nofollow">rental rates</a>! This was a months-long project that required massive collaboration between our product owner, frontend and backend engineers and QA.',ie,d,et="I wanted to highlight some work I did to make one small part of the system - the rental rate input table.",se,p,tt="Background",ne,u,lt="Without going too deep into the portable toilet business, here’s what we were trying to build.",ae,v,it="ServiceCore users are waste disposal businesses. A construction company might rent 10 portable toilets per day for the next three months from a user. That user would create a rental in ServiceCore to track their inventory and billing for that construction site.",oe,h,st="ServiceCore users can create preset line item charges, like maintenance fees. Those line item charges can attach to a rental.",re,m,nt="The problem that necessitated rental rates was these line item charges were static. There was no way to give a customer a special deal for a specific rental, like $0 service charges. You’d have to override the line item on every single invoice created for that rental. Not fun for big companies doing thousands of invoices a day!",ce,f,at="With rental rates, users would be able to select any service charge and set special per-rental pricing, notes and taxable status.",de,x,ot="In order to set rental rates, however, we needed a rate input table.",pe,C,rt="Product requirements",ue,w,ct="The rental rate input table should display every product attached to a rental. Beneath each product is a dropdown of line item charges that could be attached to a product. Selectinga charge would add it to a table, with the default price, name, description and taxable status editable.",ve,b,dt="So: rentals have products, products have line item charges, and rental rates are special per-rental instances of a line item charge. Make sense?",he,y,pt='<img src="https://i.imgur.com/nbEwLVI.png" alt="Overall view of the rate input table"/>',me,_,ut="The last two options in the line item dropdown should be “Add Service” and “Assign Service”, which I’ll explain later.",fe,g,vt="Implementation",xe,T,ht="Goals",Ce,S,mt="As every frontend developer knows, forms are complicated. This form had a lot of moving parts, so the code could turn ugly quickly.",we,H,ft="I built this with three things in mind:",be,k,xt="<li>It needed to work well for rental rates</li> <li>It needed to be reusable in case future features need a similar UI</li> <li>It needed to keep the logic under control with reactive programming</li>",ye,I,Ct='Angular’s <a href="https://angular.io/guide/reactive-forms" rel="nofollow">Reactive Forms</a> made the logic more functional and less imperative. Reactive Forms store form state in FormControls, which can be grouped inside FormGroups or FormArrays. FormGroups, FormArrays and FormControls all have first-class RxJS APIs. You can subscribe to <code>valueChanges</code> or <code>statusChanges</code> (valid/invalid) on any of them and <em>react</em> to form state updates.',_e,M,wt="Overview",ge,P,bt="When the user opens the rental rate form, the <code>rental-rate-form</code> container component loads the rental’s data. It passes any existing rental rates into the <code>rate-input-table</code>, the actual UI. The <code>rental-rate-form</code> also <code>PATCH</code>es the rental with its new rates on submit.",Te,L,yt="This component accomplishes goal #2, keeping the rental logic separate from the UI.",Se,F,_t="On instantiation, the <code>rate-input-table</code> transforms input rates into table rows using pure static functions. This keeps the instantiation logic testable.",He,A,gt="The <code>rate-input-table</code> stores its data as nested <code>AbstractControl</code>s (the base class of FormArray, FormGroup and FormControl). The structure goes: Products is a FormArray. Each product is a FormGroup that contains product name, quantity, and a FormArray of rates. Each rate is FormGroup that contains FormControls for line item name, description, price, and taxable status.",ke,q,Tt="Each product FormGroup also has a FormControl for the line item dropdown. Any value change there reactively adds the selected rate to the table.",Ie,G,St="Wins",Me,R,Ht="RxJS ♥",Pe,O,kt="Reactive programming is a blast. It contained the logic for each part of the form as subscriptions to that AbstractControl’s <code>valueChanges</code>.",Le,E,It="It also simplified working with asynchronous requests. For example, the <code>pipe</code> from add service dropdown takes the <code>valueChange</code> (the <code>id</code> of the selected service) and <code>flatMap</code>s it into a <code>GET</code> req for the full service. The full service is transformed into a new FormControl, which is pushed into the FormArray for the given product.",Fe,j,Ae,$t=`<code class="language-undefined">      // add new service on select
      const newServiceSub = rateSelectChanges.pipe(
        filter(serviceIdOrOption =&gt; &#123;
          // service ids come through as &#39;11&#39;
          const serviceId = parseInt(serviceIdOrOption, 10);
          return !Number.isNaN(serviceId);
        &#125;),
        map((serviceId: string) =&gt; parseInt(serviceId, 10)),
        flatMap(serviceId =&gt; this._serviceService.getService(serviceId))
      ).subscribe((service: Service) =&gt; &#123;
          this.addServiceToRates(service, entityFormGroup.get(&#39;rates&#39;) as FormArray);
          entityFormGroup.get(&#39;rateSelect&#39;).patchValue(&#39;choose&#39;);
        &#125;, error =&gt; this._userAlertService.error(error, true)
      );
</code>`,qe,N,Mt="No <code>async</code>/<code>await</code> weirdness, no race conditions, no confusing logic. Just functional transformations. First-class RxJS support is far and away the best part of Angular. Just look at when we have to do something <em>really</em> complicated:",Ge,J,Re,Kt=`<code class="language-undefined">      const assignServiceSub = rateSelectChanges.pipe(
        filter(selectVal =&gt; selectVal === &#39;assign&#39;),
        flatMap(() =&gt; &#123;
          const serviceIdsToExcludeFromAssociateDialog: number[] = entityFormGroup.value.entity.services
            .map(service =&gt; service.id);
          return this._serviceDialogService.openAssociateServiceDialog(
            entityFormGroup.value.entity.id,
            serviceIdsToExcludeFromAssociateDialog
          );
        &#125;),
        filter((updatedServices) =&gt; !!(updatedServices)),
        map((allServices: Service[]) =&gt; &#123;
          const previousServiceIds: number[] = entityFormGroup.value.entity?.services?.map(service =&gt; service.id) || [];
          return allServices.filter(serviceFromApi =&gt; !previousServiceIds.includes(serviceFromApi.id));
        &#125;),
        map(newServices =&gt; newServices.map(newService =&gt; this._serviceService.getService(newService.id))),
        flatMap(newServiceRequests =&gt; forkJoin(newServiceRequests))
      ).subscribe(fullNewServices =&gt; &#123;
        if (fullNewServices?.length) &#123;
          fullNewServices.forEach(service =&gt; &#123;
            this.addServiceToRates(service, entityFormGroup.get(&#39;rates&#39;) as FormArray);
          &#125;);
        &#125;
        this.reloadFullServices(entityFormGroup as FormGroup);
        entityFormGroup.get(&#39;rateSelect&#39;).patchValue(&#39;choose&#39;);
      &#125;);
</code>`,Oe,W,Pt="This block grabs services (line item charges) already associated to a product and passing them to a dialog. The dialog filters out these previously associated services. Then, if the user selects any services to add to a product in the dialog, these are passed out of the dialog’s Observable and transformed into requests for the full data for each newly associated service. When we’ve received all responses, the services are added to the table as rates. RxJS makes this kind of async work <em>easy</em>.",Ee,z,Lt="Functional programming ♥",je,U,Ft="The last code win was creating the select service dropdown. It transformed an array of services into <code>&lt;options&gt;</code>, sorting by billing period on the service.",Ne,V,At='<img src="http://i.imgur.com/sJthlnx.png" alt="The add service dropdown for ServiceCore rental rates"/>',Je,D,qt="All that logic used a pure static class function, making it a breeze to unit test.",We,B,Gt="Losses",ze,Y,Rt="<code>rate-input-table</code> almost shipped without bugs, but for a hack I did.",Ue,Q,Ot="Our product owner wanted the users to be able to select the same service from the dropdown multiple times consecutively. But, choosing the same option twice in a <code>&lt;select&gt;</code> does not fire the standard <code>change</code> event.",Ve,Z,Et="Instead of reading the <code>&lt;select&gt;</code> value on <code>change</code>, I tried reading it after the <code>click</code> event. On every browser I tested, <code>click</code> fired when you chose an option in the <code>&lt;select&gt;</code>.",De,$,jt="However, Chrome on macOS fired the click event on open <code>&lt;select&gt;</code>. Thus, you’d have to choose an <code>&lt;option&gt;</code>, then re-open the dropdown to add a service.",Be,K,Nt="When we got the bug report, I fixed it so on <code>change</code> we would grab the <code>&lt;select&gt;</code> value, add a service, and reset the <code>&lt;select&gt;</code> value.",Ye,X,Jt="I tested this on Chrome for macOS and talked to our devops guy about fixing our company process to avoid mistakes like this. We shipped the fix the same day the bug was reported. No complaints since.",Qe,ee,Wt="Conclusions",Ze,te,zt="If the drop-down bug hadn’t happened the UI would have been perfect. Normally ServiceCore sticks to standard HTML elements and doesn’t go too far off the road. It’s a lesson that if we want to try stuff like that, we need a better process.",$e,le,Ut="Still, the rental rates input UI has worked like a charm. The real test will be down the road if we try to reuse this work :).";return{c(){c=s("p"),c.innerHTML=Xe,ie=a(),d=s("p"),d.textContent=et,se=a(),p=s("h2"),p.textContent=tt,ne=a(),u=s("p"),u.textContent=lt,ae=a(),v=s("p"),v.textContent=it,oe=a(),h=s("p"),h.textContent=st,re=a(),m=s("p"),m.textContent=nt,ce=a(),f=s("p"),f.textContent=at,de=a(),x=s("p"),x.textContent=ot,pe=a(),C=s("h2"),C.textContent=rt,ue=a(),w=s("p"),w.textContent=ct,ve=a(),b=s("p"),b.textContent=dt,he=a(),y=s("p"),y.innerHTML=pt,me=a(),_=s("p"),_.textContent=ut,fe=a(),g=s("h2"),g.textContent=vt,xe=a(),T=s("h3"),T.textContent=ht,Ce=a(),S=s("p"),S.textContent=mt,we=a(),H=s("p"),H.textContent=ft,be=a(),k=s("ol"),k.innerHTML=xt,ye=a(),I=s("p"),I.innerHTML=Ct,_e=a(),M=s("h3"),M.textContent=wt,ge=a(),P=s("p"),P.innerHTML=bt,Te=a(),L=s("p"),L.textContent=yt,Se=a(),F=s("p"),F.innerHTML=_t,He=a(),A=s("p"),A.innerHTML=gt,ke=a(),q=s("p"),q.textContent=Tt,Ie=a(),G=s("h3"),G.textContent=St,Me=a(),R=s("h4"),R.textContent=Ht,Pe=a(),O=s("p"),O.innerHTML=kt,Le=a(),E=s("p"),E.innerHTML=It,Fe=a(),j=s("pre"),Ae=new Dt(!1),qe=a(),N=s("p"),N.innerHTML=Mt,Ge=a(),J=s("pre"),Re=new Dt(!1),Oe=a(),W=s("p"),W.innerHTML=Pt,Ee=a(),z=s("h4"),z.textContent=Lt,je=a(),U=s("p"),U.innerHTML=Ft,Ne=a(),V=s("p"),V.innerHTML=At,Je=a(),D=s("p"),D.textContent=qt,We=a(),B=s("h3"),B.textContent=Gt,ze=a(),Y=s("p"),Y.innerHTML=Rt,Ue=a(),Q=s("p"),Q.innerHTML=Ot,Ve=a(),Z=s("p"),Z.innerHTML=Et,De=a(),$=s("p"),$.innerHTML=jt,Be=a(),K=s("p"),K.innerHTML=Nt,Ye=a(),X=s("p"),X.textContent=Jt,Qe=a(),ee=s("h2"),ee.textContent=Wt,Ze=a(),te=s("p"),te.textContent=zt,$e=a(),le=s("p"),le.textContent=Ut,this.h()},l(e){c=n(e,"P",{"data-svelte-h":!0}),r(c)!=="svelte-m9okwt"&&(c.innerHTML=Xe),ie=o(e),d=n(e,"P",{"data-svelte-h":!0}),r(d)!=="svelte-lh4lp6"&&(d.textContent=et),se=o(e),p=n(e,"H2",{"data-svelte-h":!0}),r(p)!=="svelte-1c47mae"&&(p.textContent=tt),ne=o(e),u=n(e,"P",{"data-svelte-h":!0}),r(u)!=="svelte-1noq4pe"&&(u.textContent=lt),ae=o(e),v=n(e,"P",{"data-svelte-h":!0}),r(v)!=="svelte-rwr9bo"&&(v.textContent=it),oe=o(e),h=n(e,"P",{"data-svelte-h":!0}),r(h)!=="svelte-1oy0ppe"&&(h.textContent=st),re=o(e),m=n(e,"P",{"data-svelte-h":!0}),r(m)!=="svelte-1wg13qr"&&(m.textContent=nt),ce=o(e),f=n(e,"P",{"data-svelte-h":!0}),r(f)!=="svelte-1hs9kbo"&&(f.textContent=at),de=o(e),x=n(e,"P",{"data-svelte-h":!0}),r(x)!=="svelte-1iqna8n"&&(x.textContent=ot),pe=o(e),C=n(e,"H2",{"data-svelte-h":!0}),r(C)!=="svelte-1djpdnr"&&(C.textContent=rt),ue=o(e),w=n(e,"P",{"data-svelte-h":!0}),r(w)!=="svelte-1n5j1rg"&&(w.textContent=ct),ve=o(e),b=n(e,"P",{"data-svelte-h":!0}),r(b)!=="svelte-r8ymae"&&(b.textContent=dt),he=o(e),y=n(e,"P",{"data-svelte-h":!0}),r(y)!=="svelte-xsqfp8"&&(y.innerHTML=pt),me=o(e),_=n(e,"P",{"data-svelte-h":!0}),r(_)!=="svelte-1gttssc"&&(_.textContent=ut),fe=o(e),g=n(e,"H2",{"data-svelte-h":!0}),r(g)!=="svelte-1y7y6hs"&&(g.textContent=vt),xe=o(e),T=n(e,"H3",{"data-svelte-h":!0}),r(T)!=="svelte-17ftxjm"&&(T.textContent=ht),Ce=o(e),S=n(e,"P",{"data-svelte-h":!0}),r(S)!=="svelte-jr8si8"&&(S.textContent=mt),we=o(e),H=n(e,"P",{"data-svelte-h":!0}),r(H)!=="svelte-cvkad1"&&(H.textContent=ft),be=o(e),k=n(e,"OL",{"data-svelte-h":!0}),r(k)!=="svelte-18r2mbh"&&(k.innerHTML=xt),ye=o(e),I=n(e,"P",{"data-svelte-h":!0}),r(I)!=="svelte-php1gy"&&(I.innerHTML=Ct),_e=o(e),M=n(e,"H3",{"data-svelte-h":!0}),r(M)!=="svelte-1diyj43"&&(M.textContent=wt),ge=o(e),P=n(e,"P",{"data-svelte-h":!0}),r(P)!=="svelte-q2e2ms"&&(P.innerHTML=bt),Te=o(e),L=n(e,"P",{"data-svelte-h":!0}),r(L)!=="svelte-1qps8sm"&&(L.textContent=yt),Se=o(e),F=n(e,"P",{"data-svelte-h":!0}),r(F)!=="svelte-1y2ceb6"&&(F.innerHTML=_t),He=o(e),A=n(e,"P",{"data-svelte-h":!0}),r(A)!=="svelte-5dz8qa"&&(A.innerHTML=gt),ke=o(e),q=n(e,"P",{"data-svelte-h":!0}),r(q)!=="svelte-v17d0t"&&(q.textContent=Tt),Ie=o(e),G=n(e,"H3",{"data-svelte-h":!0}),r(G)!=="svelte-321qzr"&&(G.textContent=St),Me=o(e),R=n(e,"H4",{"data-svelte-h":!0}),r(R)!=="svelte-2a7m58"&&(R.textContent=Ht),Pe=o(e),O=n(e,"P",{"data-svelte-h":!0}),r(O)!=="svelte-j8dkhv"&&(O.innerHTML=kt),Le=o(e),E=n(e,"P",{"data-svelte-h":!0}),r(E)!=="svelte-kwf6fl"&&(E.innerHTML=It),Fe=o(e),j=n(e,"PRE",{class:!0});var t=Bt(j);Ae=Yt(t,!1),t.forEach(l),qe=o(e),N=n(e,"P",{"data-svelte-h":!0}),r(N)!=="svelte-1l9xoar"&&(N.innerHTML=Mt),Ge=o(e),J=n(e,"PRE",{class:!0});var Vt=Bt(J);Re=Yt(Vt,!1),Vt.forEach(l),Oe=o(e),W=n(e,"P",{"data-svelte-h":!0}),r(W)!=="svelte-lhs0p1"&&(W.innerHTML=Pt),Ee=o(e),z=n(e,"H4",{"data-svelte-h":!0}),r(z)!=="svelte-1hogjrx"&&(z.textContent=Lt),je=o(e),U=n(e,"P",{"data-svelte-h":!0}),r(U)!=="svelte-1ct9rvy"&&(U.innerHTML=Ft),Ne=o(e),V=n(e,"P",{"data-svelte-h":!0}),r(V)!=="svelte-bc975"&&(V.innerHTML=At),Je=o(e),D=n(e,"P",{"data-svelte-h":!0}),r(D)!=="svelte-1rljkqd"&&(D.textContent=qt),We=o(e),B=n(e,"H3",{"data-svelte-h":!0}),r(B)!=="svelte-1nm1uzz"&&(B.textContent=Gt),ze=o(e),Y=n(e,"P",{"data-svelte-h":!0}),r(Y)!=="svelte-1kx1o23"&&(Y.innerHTML=Rt),Ue=o(e),Q=n(e,"P",{"data-svelte-h":!0}),r(Q)!=="svelte-yzrl5m"&&(Q.innerHTML=Ot),Ve=o(e),Z=n(e,"P",{"data-svelte-h":!0}),r(Z)!=="svelte-15ie8r3"&&(Z.innerHTML=Et),De=o(e),$=n(e,"P",{"data-svelte-h":!0}),r($)!=="svelte-grk0d3"&&($.innerHTML=jt),Be=o(e),K=n(e,"P",{"data-svelte-h":!0}),r(K)!=="svelte-f6721p"&&(K.innerHTML=Nt),Ye=o(e),X=n(e,"P",{"data-svelte-h":!0}),r(X)!=="svelte-115hqvm"&&(X.textContent=Jt),Qe=o(e),ee=n(e,"H2",{"data-svelte-h":!0}),r(ee)!=="svelte-lmdog2"&&(ee.textContent=Wt),Ze=o(e),te=n(e,"P",{"data-svelte-h":!0}),r(te)!=="svelte-ore47x"&&(te.textContent=zt),$e=o(e),le=n(e,"P",{"data-svelte-h":!0}),r(le)!=="svelte-1cem0pp"&&(le.textContent=Ut),this.h()},h(){Ae.a=null,Qt(j,"class","language-undefined"),Re.a=null,Qt(J,"class","language-undefined")},m(e,t){i(e,c,t),i(e,ie,t),i(e,d,t),i(e,se,t),i(e,p,t),i(e,ne,t),i(e,u,t),i(e,ae,t),i(e,v,t),i(e,oe,t),i(e,h,t),i(e,re,t),i(e,m,t),i(e,ce,t),i(e,f,t),i(e,de,t),i(e,x,t),i(e,pe,t),i(e,C,t),i(e,ue,t),i(e,w,t),i(e,ve,t),i(e,b,t),i(e,he,t),i(e,y,t),i(e,me,t),i(e,_,t),i(e,fe,t),i(e,g,t),i(e,xe,t),i(e,T,t),i(e,Ce,t),i(e,S,t),i(e,we,t),i(e,H,t),i(e,be,t),i(e,k,t),i(e,ye,t),i(e,I,t),i(e,_e,t),i(e,M,t),i(e,ge,t),i(e,P,t),i(e,Te,t),i(e,L,t),i(e,Se,t),i(e,F,t),i(e,He,t),i(e,A,t),i(e,ke,t),i(e,q,t),i(e,Ie,t),i(e,G,t),i(e,Me,t),i(e,R,t),i(e,Pe,t),i(e,O,t),i(e,Le,t),i(e,E,t),i(e,Fe,t),i(e,j,t),Ae.m($t,j),i(e,qe,t),i(e,N,t),i(e,Ge,t),i(e,J,t),Re.m(Kt,J),i(e,Oe,t),i(e,W,t),i(e,Ee,t),i(e,z,t),i(e,je,t),i(e,U,t),i(e,Ne,t),i(e,V,t),i(e,Je,t),i(e,D,t),i(e,We,t),i(e,B,t),i(e,ze,t),i(e,Y,t),i(e,Ue,t),i(e,Q,t),i(e,Ve,t),i(e,Z,t),i(e,De,t),i(e,$,t),i(e,Be,t),i(e,K,t),i(e,Ye,t),i(e,X,t),i(e,Qe,t),i(e,ee,t),i(e,Ze,t),i(e,te,t),i(e,$e,t),i(e,le,t)},p:Ke,i:Ke,o:Ke,d(e){e&&(l(c),l(ie),l(d),l(se),l(p),l(ne),l(u),l(ae),l(v),l(oe),l(h),l(re),l(m),l(ce),l(f),l(de),l(x),l(pe),l(C),l(ue),l(w),l(ve),l(b),l(he),l(y),l(me),l(_),l(fe),l(g),l(xe),l(T),l(Ce),l(S),l(we),l(H),l(be),l(k),l(ye),l(I),l(_e),l(M),l(ge),l(P),l(Te),l(L),l(Se),l(F),l(He),l(A),l(ke),l(q),l(Ie),l(G),l(Me),l(R),l(Pe),l(O),l(Le),l(E),l(Fe),l(j),l(qe),l(N),l(Ge),l(J),l(Oe),l(W),l(Ee),l(z),l(je),l(U),l(Ne),l(V),l(Je),l(D),l(We),l(B),l(ze),l(Y),l(Ue),l(Q),l(Ve),l(Z),l(De),l($),l(Be),l(K),l(Ye),l(X),l(Qe),l(ee),l(Ze),l(te),l($e),l(le))}}}const nl={layout:"post",title:"Using Angular reactive forms to build a huge feature for ServiceCore",image:"rental-rates.png",date:"2020-05-16T00:00:00.000Z",caption:"And it looks so simple from the outside to use."};class al extends el{constructor(c){super(),tl(this,c,null,ll,Xt,{})}}export{al as default,nl as metadata};
